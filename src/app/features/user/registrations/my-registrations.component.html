<div class="registrations-container">
  <app-toolbar
    title="My Registrations"
    [showBackButton]="true"
    backButtonText="Back to Events"
    [showLogout]="true"
    [currentUser]="currentUser"
    (back)="goToHome()"
    (logout)="logout()">
    <div toolbarActions>
      <button (click)="browseEvents()" class="btn-nav-secondary">
        Browse Events
      </button>
    </div>
  </app-toolbar>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading your registrations...</p>
    </div>
  }

  <!-- Registrations List -->
  @if (!loading() && registrations().length > 0) {
    <div class="registrations-summary">
      <p>You have {{ totalElements() }} registration(s)</p>
    </div>

    <div class="registrations-list">
      @for (registration of registrations(); track registration.id) {
        <div class="registration-card" [class.past-event]="!isEventUpcoming(registration)">
          <div class="card-header">
            <div class="event-info">
              @if (registration.event.category?.name) {
                <span class="event-category">{{ registration.event.category!.name }}</span>
              }
              <span class="registration-status" [class]="getStatusClass(registration.status)">
                {{ registration.status }}
              </span>
              @if (isEventToday(registration)) {
                <span class="event-badge today">Today</span>
              } @else if (isEventUpcoming(registration)) {
                <span class="event-badge upcoming">Upcoming</span>
              } @else {
                <span class="event-badge past">Past</span>
              }
            </div>
          </div>

          <div class="card-body">
            <h3 class="event-title" (click)="viewEvent(registration.event.id)">
              {{ registration.event.title }}
            </h3>
            <p class="event-description">{{ registration.event.description }}</p>

            <div class="event-details">
              <div class="detail-row">
                <span class="detail-icon">üìÖ</span>
                <span class="detail-text">{{ getEventDate(registration) }}</span>
              </div>

              <div class="detail-row">
                <span class="detail-icon">üïê</span>
                <span class="detail-text">{{ getEventTime(registration) }}</span>
              </div>

              <div class="detail-row">
                <span class="detail-icon">üìç</span>
                <span class="detail-text">{{ registration.event.location }}</span>
              </div>

              <div class="detail-row">
                <span class="detail-icon">‚úì</span>
                <span class="detail-text">
                  Registered on {{ getRegistrationDate(registration) }}
                </span>
              </div>
            </div>

            @if (registration.notes) {
              <div class="registration-notes">
                <strong>Notes:</strong> {{ registration.notes }}
              </div>
            }
          </div>

          <div class="card-footer">
            <button (click)="viewEvent(registration.event.id)" class="btn-view">
              View Event Details
            </button>
            @if (registration.status.toLowerCase() === 'confirmed') {
              <button (click)="openQRCodeModal(registration)" class="btn-qr">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                  <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                View QR Code
              </button>
            }
            @if (isEventUpcoming(registration) && registration.status.toLowerCase() === 'confirmed') {
              <button (click)="openCancelDialog(registration)" class="btn-cancel">
                Cancel Registration
              </button>
            }
          </div>
        </div>
      }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1) {
      <div class="pagination">
        <button
          (click)="previousPage()"
          [disabled]="currentPage() === 0"
          class="btn-page"
        >
          Previous
        </button>

        <div class="page-numbers">
          @for (page of [].constructor(totalPages()); track $index) {
            <button
              (click)="goToPage($index)"
              [class.active]="currentPage() === $index"
              class="btn-page-number"
            >
              {{ $index + 1 }}
            </button>
          }
        </div>

        <button
          (click)="nextPage()"
          [disabled]="currentPage() === totalPages() - 1"
          class="btn-page"
        >
          Next
        </button>
      </div>
    }
  }

  <!-- Empty State -->
  @if (!loading() && registrations().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üìã</div>
      <h2>No Registrations Yet</h2>
      <p>You haven't registered for any events yet. Browse our events and register for upcoming activities!</p>
      <button (click)="browseEvents()" class="btn-browse">
        Browse Events
      </button>
    </div>
  }

  <!-- Cancel Registration Confirmation Dialog -->
  <app-confirmation-dialog
    [show]="showCancelDialog"
    [title]="'Cancel Registration'"
    [message]="'Are you sure you want to cancel your registration?'"
    [confirmText]="'Yes, Cancel Registration'"
    [cancelText]="'Keep Registration'"
    [confirmButtonClass]="'btn-danger'"
    [isProcessing]="cancelling"
    (confirmed)="confirmCancelRegistration()"
    (cancelled)="closeCancelDialog()"
  ></app-confirmation-dialog>

  <!-- Cancel Success Dialog -->
  <app-success-dialog
    [show]="showCancelSuccessDialog"
    [title]="'Registration Cancelled'"
    [message]="'Your registration has been successfully cancelled. You can register for other events anytime.'"
    [buttonText]="'Close'"
    [type]="'success'"
    (closed)="closeCancelSuccessDialog()"
  ></app-success-dialog>

  <!-- QR Code Modal -->
  @if (showQRCodeModal()) {
    <div class="modal-overlay" (click)="closeQRCodeModal()">
      <div class="qr-modal-content" (click)="$event.stopPropagation()">
        <div class="qr-modal-header">
          <h2>Event QR Code</h2>
          <button class="btn-close" (click)="closeQRCodeModal()">&times;</button>
        </div>

        <div class="qr-modal-body">
          @if (selectedRegistration) {
            <div class="event-info-section">
              <h3>{{ selectedRegistration.event.title }}</h3>
              <p class="event-date">{{ getEventDate(selectedRegistration) }}</p>
              <p class="registration-id">Registration ID: {{ selectedRegistration.id }}</p>
            </div>

            <div class="qr-code-section">
              <div class="qr-code-canvas">
                <qrcode
                  [qrdata]="qrCodeData()"
                  [width]="280"
                  [errorCorrectionLevel]="'M'"
                  [elementType]="'canvas'"
                  [margin]="2"
                ></qrcode>
              </div>
              <p class="qr-instructions">
                Show this QR code at the event entrance for quick check-in
              </p>
            </div>
          }
        </div>

        <div class="qr-modal-footer">
          <button class="btn-download" (click)="downloadQRCode()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Download QR Code
          </button>
          <button class="btn-close-modal" (click)="closeQRCodeModal()">Close</button>
        </div>
      </div>
    </div>
  }
</div>
